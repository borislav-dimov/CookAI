<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChefAI - Scan Details</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        /* --- COPY/PASTE GLOBAL STYLES FROM account.html/index.html --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }

        :root {
            --ios-bg: #f2f2f7;
            --ios-card: #ffffff;
            --ios-text: #0b0b0f;
            --ios-secondary: #6b6b74;
            --ios-border: #e5e5ea;
            --ios-accent: #007aff;
            --ios-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            --ios-shadow-soft: 0 6px 20px rgba(15, 23, 42, 0.08);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; background-color: var(--ios-bg); height: 100vh; width: 100vw;
            overflow: hidden; display: flex; justify-content: center;
            color: var(--ios-text);
        }
        .app-shell {
            width: 100%; height: 100%; background-color: var(--ios-bg);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        @media (min-width: 900px) {
            body { align-items: center; }
            /* Mobile frame constraint */
            .app-shell { max-width: 414px; height: 896px; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        }
        
        /* Header */
        .top-bar {
            height: 64px; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; 
            justify-content: space-between; padding: env(safe-area-inset-top) 10px 0 20px; z-index: 20; 
            flex-shrink: 0; border-bottom: 1px solid var(--ios-border); 
            backdrop-filter: blur(18px) saturate(180%);
        }
        .header-title { font-size: 1.05rem; font-weight: 600; color: var(--ios-text); }
        .back-btn { text-decoration: none; color: var(--ios-accent); font-size: 0.95rem; font-weight: 500; }
        
        /* Content & Recipe Cards (Copied from index.html results screen) */
        .content-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .recipe-card {
            background: var(--ios-card); border-radius: 20px; overflow: hidden;
            margin-bottom: 20px; box-shadow: var(--ios-shadow-soft);
            border: 1px solid rgba(229, 229, 234, 0.7);
        }
        .recipe-img { width: 100%; height: 200px; object-fit: cover; }
        .recipe-body { padding: 20px; }
        .recipe-title { font-size: 1.4rem; margin: 0 0 10px 0; font-weight: 700; color: var(--ios-text); }
        .recipe-description { font-size: 0.9rem; opacity: 0.7; margin-bottom: 15px; color: var(--ios-secondary); }
        .recipe-section-title { font-size: 1.05rem; font-weight: 600; margin: 20px 0 10px 0; color: var(--ios-text); }
        .recipe-list { padding: 0 0 0 20px; margin: 0; font-size: 0.95rem; line-height: 1.6; }
        
        /* Buttons */
        .btn-primary {
            background-color: #0b0b0f; color: white; border: none; padding: 12px 24px; 
            border-radius: 999px; font-weight: 600; cursor: pointer; width: 100%;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2);
        }
        .btn-secondary { /* Added styling for secondary buttons (like Back/Finish) */
            background-color: #f2f2f7;
            color: var(--ios-text);
            border: 1px solid var(--ios-border);
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        }
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: default;
        }
        
        /* Navigation (Copy/Paste) */
        .bottom-nav {
            height: 86px; background: rgba(255, 255, 255, 0.92); display: flex; justify-content: space-around; 
            align-items: center; padding-bottom: calc(env(safe-area-inset-bottom) + 6px); border-top: 1px solid var(--ios-border); flex-shrink: 0;
            box-shadow: 0 -10px 30px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(18px) saturate(180%);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: var(--ios-secondary); cursor: pointer; 
            font-size: 0.95rem; font-weight: 500; gap: 6px; text-decoration: none;
        }
        .nav-item.active { color: var(--ios-text); font-weight: 600; }
        .nav-icon { font-size: 30px; display: block; }
        
        /* --- RECIPE STATS STYLES --- */
        .recipe-header { position: relative; }
        .recipe-stats {
            position: absolute; top: 15px; right: 15px; z-index: 10;
            display: flex; flex-direction: column; gap: 8px;
        }
        .stat-box {
            padding: 8px 12px; border-radius: 10px; font-weight: 600;
            font-size: 0.85rem; text-align: center; box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
            min-width: 90px;
            backdrop-filter: blur(6px);
        }
        .time-box { background-color: rgba(229, 229, 234, 0.9); color: #333; }
        .skill-box.Easy { background-color: #4CAF50; color: white; }
        .skill-box.Medium { background-color: #FFC107; color: #333; }
        .skill-box.Hard { background-color: #F44336; color: white; }
        
        /* --- RECIPE COOKING MODE STYLES --- */
        #recipeModeOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--ios-bg); 
            z-index: 1000; 
            display: none; /* Changed initial state to display: none */
            flex-direction: column; 
            /* Initial state: Hidden off-screen to the right, to prevent showing up on load */
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* The following media query applies the mobile frame constraints and centering to the overlay */
        @media (min-width: 900px) {
            #recipeModeOverlay {
                max-width: 414px; /* Inherit width from app-shell */
                height: 896px; /* Inherit height from app-shell */
                border-radius: 40px; /* Inherit border-radius from app-shell */
                box-shadow: 0 20px 50px rgba(0,0,0,0.2);
                /* Center the overlay within the body/desktop view */
                left: 50%;
                top: 50%;
                transform: translate(-50%, 100%); /* Start off-screen below center */
            }
            #recipeModeOverlay.active {
                /* Slide up to be centered */
                transform: translate(-50%, -50%);
            }
        }

        /* Activation state (Applies on mobile and desktop) */
        #recipeModeOverlay.active {
            display: flex; /* Show the overlay */
            transform: translateY(0); /* Slide into view (mobile) */
        }
        /* Specific override for desktop centering */
        @media (min-width: 900px) {
            #recipeModeOverlay.active {
                transform: translate(-50%, -50%);
            }
        }

        .mode-content {
            background-color: transparent;
            padding: 0; 
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .cook-header {
            padding: 20px 20px 10px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(18px) saturate(180%);
            border-bottom: 1px solid var(--ios-border);
            flex-shrink: 0;
        }
        .cook-header .close-btn {
            float: right; border: none; background: none; font-size: 24px; color: #999; cursor: pointer;
        }
        #modeRecipeTitle {
            margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--ios-text);
        }
        .step-counter {
            color: var(--ios-secondary); font-size: 0.9rem; font-weight: 500; margin-top: 5px;
        }
        .step-instruction {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            padding: 30px; text-align: center; overflow-y: auto;
            font-size: 1.6rem; line-height: 1.4; font-weight: 600; color: var(--ios-text);
        }
        /* Style for the final step */
        .step-instruction.finished-message {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--ios-accent); /* iOS blue color for success */
        }
        .mode-controls {
            padding: 20px; display: flex; justify-content: space-between;
            background: rgba(255, 255, 255, 0.94); border-top: 1px solid var(--ios-border); flex-shrink: 0;
            backdrop-filter: blur(18px) saturate(180%);
            gap: 15px; margin-top: 0;
        }
        .mode-controls .btn-primary, .mode-controls .btn-secondary {
            width: auto;
            flex-grow: 1;
        }

        /* --- DARK MODE OVERRIDES --- */
        body.dark-mode {
            --ios-bg: #0b0b0f;
            --ios-card: #1c1c1e;
            --ios-text: #f5f5f7;
            --ios-secondary: #a1a1aa;
            --ios-border: #2c2c2e;
            --ios-accent: #0a84ff;
        }
        body.dark-mode { background-color: var(--ios-bg); }
        body.dark-mode .app-shell { background-color: var(--ios-bg); }
        body.dark-mode .top-bar,
        body.dark-mode .bottom-nav,
        body.dark-mode .cook-header,
        body.dark-mode .mode-controls,
        body.dark-mode #recipeModeOverlay { /* Added overlay background fix for dark mode */
            background-color: rgba(28, 28, 30, 0.92); 
            border-color: var(--ios-border); 
        }
        body.dark-mode .header-title,
        body.dark-mode .recipe-title,
        body.dark-mode .recipe-section-title,
        body.dark-mode .step-instruction,
        body.dark-mode #modeRecipeTitle { color: #fff; }
        body.dark-mode .back-btn { color: var(--ios-accent); }
        body.dark-mode .nav-item { color: var(--ios-secondary); }
        body.dark-mode .nav-item.active { color: var(--ios-text); }
        body.dark-mode .recipe-card { background-color: var(--ios-card); border-color: var(--ios-border); }
        body.dark-mode .time-box { background-color: rgba(44, 44, 46, 0.9); color: var(--ios-text); }
        body.dark-mode .skill-box.Medium { color: #333; } /* Keep text dark on yellow background */
        body.dark-mode .btn-primary { background-color: var(--ios-accent); }
        body.dark-mode .btn-secondary { background-color: #2c2c2e; color: var(--ios-text); border-color: #3a3a3c; }
        body.dark-mode .cook-header .close-btn { color: var(--ios-secondary); }
        body.dark-mode .step-counter { color: var(--ios-secondary); }
        body.dark-mode .step-instruction.finished-message { color: #636366; }
    </style>
</head>
<body class="{{ 'dark-mode' if userSettings.mode == 'dark' else 'light-mode' }}">

<div class="app-shell" id="appShell">
    
    <div class="top-bar">
        <a href="{{ url_for('account_page') }}" class="back-btn">
            <ion-icon name="chevron-back-outline" style="font-size: 1.2rem; vertical-align: middle;"></ion-icon>
            Account
        </a>
        <div class="header-title">Scan Details</div>
        <div style="width: 60px;"></div> </div>

    <div class="content-container">
        <h2 style="font-size: 1.6rem; margin: 0 0 10px 0;">Generated Recipes</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 25px;">
            Scan date: {{ scan_data.date }}
        </p>

        {% for recipe in scan_data.recipes %}
        <div class="recipe-card">
            
            <div class="recipe-header"> 
                <img src="{{ recipe.image_url }}" class="recipe-img" alt="{{ recipe.title }}">

                <div class="recipe-stats">
                    
                    <div class="stat-box time-box">
                        <ion-icon name="time-outline"></ion-icon> 
                        {{ recipe.time_minutes }} min
                    </div>

                    <div class="stat-box skill-box {{ recipe.skill_level }}">
                        {{ recipe.skill_level }}
                    </div>
                </div>
            </div>
            <div class="recipe-body">
                <h3 class="recipe-title">{{ recipe.title }}</h3>
                <p class="recipe-description">{{ recipe.description }}</p>

                <h4 class="recipe-section-title">Ingredients</h4>
                <ul class="recipe-list">
                    {% for ingredient in recipe.ingredients %}
                    <li>{{ ingredient }}</li>
                    {% endfor %}
                </ul>

                <h4 class="recipe-section-title">Instructions</h4>
                <ol class="recipe-list">
                    {% for instruction in recipe.instructions %}
                    <li>{{ instruction }}</li>
                    {% endfor %}
                </ol>
                
                <button class="btn-primary start-cooking-btn" style="margin-top: 25px;" 
    data-instructions='{{ recipe.instructions | tojson }}' 
    data-title="{{ recipe.title | e }}"> 
    Start Cooking 
</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="bottom-nav">
        <a href="{{ url_for('account_page') }}" class="nav-item {% if active_tab == 'account' %}active{% endif %}">
            <ion-icon name="{{ 'person-circle' if active_tab == 'account' else 'person-circle-outline' }}" class="nav-icon"></ion-icon>
            <span>Account</span>
        </a>
        
        <a href="{{ url_for('index_page') }}" class="nav-item {% if active_tab == 'scan' %}active{% endif %}">
            <ion-icon name="camera-outline" class="nav-icon"></ion-icon>
            <span>Scan</span>
        </a>
        
        <div class="nav-item" onclick="alert('Upload from gallery is available on the Scan page!')">
            <ion-icon name="folder-open-outline" class="nav-icon"></ion-icon>
            <span>Upload</span>
        </div>
        
    </div>

</div>

<div id="recipeModeOverlay">
    <div class="mode-content">
        
        <div class="cook-header">
            <button onclick="handleFinish()" class="close-btn">Ã—</button>
            <h2 id="modeRecipeTitle" style="margin:0;"></h2>
            <p class="step-counter" id="cookCounter">
                Step <span id="currentStepNumber">1</span> of <span id="totalStepsNumber"></span>
            </p>
        </div>

        <div class="step-instruction" id="currentInstruction"></div>

        <div class="mode-controls">
            <button class="btn-secondary" id="backBtn" disabled>Back</button>
            <button class="btn-primary" id="nextBtn">Next</button>
        </div>
    </div>
</div>

<script>
    // Global state variables for the cooking mode
    let currentInstructions = [];
    let currentStepIndex = 0;
    let recipeTitle = "";
    const FINISH_MESSAGE = "Congratulations! You finished cooking! Enjoy your meal."; // New final step message

    const overlay = document.getElementById('recipeModeOverlay');
    const titleElement = document.getElementById('modeRecipeTitle');
    const stepNumberElement = document.getElementById('currentStepNumber');
    const totalStepsElement = document.getElementById('totalStepsNumber');
    const instructionElement = document.getElementById('currentInstruction');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const appShell = document.getElementById('appShell'); 

    // --------------------------------------------------------
    // Event listener attachment for dynamic elements
    // --------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const startButtons = document.querySelectorAll('.start-cooking-btn');
        
        startButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                const instructionsJSON = this.getAttribute('data-instructions');
                const title = this.getAttribute('data-title');
                
                try {
                    // Create a new instruction list that includes the final step
                    let instructions = JSON.parse(instructionsJSON);
                    instructions.push(FINISH_MESSAGE); // Add the dedicated final message
                    
                    startRecipe(instructions, title);
                } catch (e) {
                    console.error("Error parsing recipe data:", e);
                    alert("Error: Could not start recipe due to invalid instruction data.");
                }
            });
        });

        // Set up static listeners for the modal control buttons
        nextBtn.onclick = handleNext;
        backBtn.onclick = handleBack;
    });

    // 1. Function to start the recipe mode
    function startRecipe(instructions, title) {
        currentInstructions = instructions;
        currentStepIndex = 0;
        recipeTitle = title;
        
        if (currentInstructions.length <= 1) { // 1 because the finish message is always added
            alert("No instructions found for this recipe.");
            return;
        }
        
        // Setup initial display
        // The total number of steps is the instructions array length MINUS the finish message
        totalStepsElement.textContent = currentInstructions.length - 1; 
        titleElement.textContent = recipeTitle;
        
        // Use display: flex to enable the slide-in transition
        overlay.style.display = 'flex';
        overlay.classList.add('active');
        
        updateStep();
    }

    // 2. Function to update the step view and button states
    function updateStep() {
        const totalSteps = currentInstructions.length;

        if (currentStepIndex >= 0 && currentStepIndex < totalSteps) {
            
            instructionElement.textContent = currentInstructions[currentStepIndex];

            // Check if it's the custom final step (the last item in the array)
            if (currentStepIndex === totalSteps - 1) {
                // Final Step UI
                stepNumberElement.textContent = totalSteps - 1; // Keep the number at the last official step count
                totalStepsElement.textContent = totalSteps - 1;

                instructionElement.classList.add('finished-message');
                nextBtn.textContent = 'Done';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-secondary');
                backBtn.disabled = false; // Allow going back from the final screen
            } else {
                // Normal Step UI
                instructionElement.classList.remove('finished-message');
                stepNumberElement.textContent = currentStepIndex + 1;
                totalStepsElement.textContent = totalSteps - 1; // Total steps excluding finish message

                nextBtn.textContent = 'Next';
                nextBtn.classList.add('btn-primary');
                nextBtn.classList.remove('btn-secondary');

                backBtn.disabled = currentStepIndex === 0;
            }
        }
    }

    // 3. Handle 'Next' or 'Done' button click
    function handleNext() {
        const totalSteps = currentInstructions.length;

        if (currentStepIndex < totalSteps - 1) {
            currentStepIndex++;
            updateStep();
        } else {
            // FINISH action: The final step button (Done) was pressed
            handleFinish();
        }
    }

    // 4. Handle 'Back' button click
    function handleBack() {
        if (currentStepIndex > 0) {
            currentStepIndex--;
            updateStep();
        }
    }

    // Function to handle closing the cooking mode
    function handleFinish() {
        overlay.classList.remove('active'); // Start the slide-out transition
        
        // Wait for the transition to finish before hiding the element
        // This ensures the slide-out animation completes visually
        setTimeout(() => {
            overlay.style.display = 'none'; // Completely hide the element after transition
        }, 300); // 300ms matches the CSS transition duration
    }
</script>

</body>
</html>
